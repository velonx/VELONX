"use client";

import { useState, useEffect } from "react";
import { useSession } from "next-auth/react";
import { useRouter } from "next/navigation";
import dynamic from "next/dynamic";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
    Layout,
    PenTool,
    BarChart3,
    Calendar,
    Eye,
    Settings,
    ShieldCheck,
    Users,
    Lightbulb,
    Activity,
    Briefcase,
    BookOpen
} from "lucide-react";
import toast from "react-hot-toast";
import { useUserRequests, usePlatformStats } from "@/lib/api/hooks";
import { adminApi } from "@/lib/api/client";

// Dynamic imports for large components to enable code splitting
const ProjectSubmissions = dynamic(() => import("@/components/admin/ProjectSubmissions"), {
    loading: () => <div className="flex items-center justify-center p-8"><div className="w-8 h-8 border-4 border-[#219EBC] border-t-transparent rounded-full animate-spin" /></div>
});
const CareerManagement = dynamic(() => import("@/components/admin/CareerManagement"), {
    loading: () => <div className="flex items-center justify-center p-8"><div className="w-8 h-8 border-4 border-[#219EBC] border-t-transparent rounded-full animate-spin" /></div>
});
const PerformanceMetrics = dynamic(() => import("@/components/admin/PerformanceMetrics"), {
    loading: () => <div className="flex items-center justify-center p-8"><div className="w-8 h-8 border-4 border-[#219EBC] border-t-transparent rounded-full animate-spin" /></div>
});
const UserManagement = dynamic(() => import("@/components/admin/UserManagement"), {
    loading: () => <div className="flex items-center justify-center p-8"><div className="w-8 h-8 border-4 border-[#219EBC] border-t-transparent rounded-full animate-spin" /></div>
});
const BlogManagement = dynamic(() => import("@/components/admin/ContentManagement").then(mod => ({ default: mod.BlogManagement })), {
    loading: () => <div className="flex items-center justify-center p-8"><div className="w-8 h-8 border-4 border-[#219EBC] border-t-transparent rounded-full animate-spin" /></div>
});
const ResourceManagement = dynamic(() => import("@/components/admin/ContentManagement").then(mod => ({ default: mod.ResourceManagement })), {
    loading: () => <div className="flex items-center justify-center p-8"><div className="w-8 h-8 border-4 border-[#219EBC] border-t-transparent rounded-full animate-spin" /></div>
});
const MentorApplications = dynamic(() => import("@/components/admin/MentorManagement").then(mod => ({ default: mod.MentorApplications })), {
    loading: () => <div className="flex items-center justify-center p-8"><div className="w-8 h-8 border-4 border-[#219EBC] border-t-transparent rounded-full animate-spin" /></div>
});


export default function AdminDashboard() {
    const { data: session, status } = useSession();
    const router = useRouter();
    const [activeTab, setActiveTab] = useState("management");
    
    // Mentor management state
    const [mentorApplications, setMentorApplications] = useState<any[]>([]);
    const [loadingApplications, setLoadingApplications] = useState(false);

    // Fetch real data from API
    const { data: userRequests, loading: requestsLoading, refetch: refetchRequests } = useUserRequests({ 
        status: 'PENDING',
        pageSize: 10 
    });
    const { data: platformStats, loading: statsLoading } = usePlatformStats();

    // Fetch mentor applications when mentor tab is active
    useEffect(() => {
        if (activeTab === "mentors") {
            fetchMentorApplications();
        }
    }, [activeTab]);

    const fetchMentorApplications = async () => {
        setLoadingApplications(true);
        try {
            const response = await fetch('/api/admin/requests?type=MENTOR_APPLICATION&status=PENDING&pageSize=50');
            const data = await response.json();
            if (data.success) {
                setMentorApplications(data.data);
            }
        } catch (error) {
            toast.error("Failed to load mentor applications");
        } finally {
            setLoadingApplications(false);
        }
    };

    const handleApproveMentorApplication = async (requestId: string, userId: string, userName: string) => {
        try {
            await adminApi.approveRequest(requestId);
            toast.success(`Mentor application for "${userName}" approved!`);
            fetchMentorApplications();
        } catch (error) {
            toast.error("Failed to approve application");
        }
    };

    const handleRejectMentorApplication = async (requestId: string, userName: string) => {
        try {
            await adminApi.rejectRequest(requestId, 'Application rejected by admin');
            toast.success(`Mentor application for "${userName}" rejected.`);
            fetchMentorApplications();
        } catch (error) {
            toast.error("Failed to reject application");
        }
    };

    useEffect(() => {
        if (status === "loading") return;
        
        if (status === "unauthenticated") {
            router.push("/auth/login");
        } else if (status === "authenticated" && session?.user?.role !== "ADMIN") {
            router.push("/dashboard/student");
        }
    }, [status, session, router]);

    if (status === "loading") {
        return (
            <div className="min-h-screen flex items-center justify-center">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#219EBC] mx-auto mb-4"></div>
                    <p className="text-gray-600">Loading...</p>
                </div>
            </div>
        );
    }

    if (status === "unauthenticated" || session?.user?.role !== "ADMIN") {
        return null;
    }

    const navItems = [
        { icon: Layout, label: "Management", value: "management" },
        { icon: Users, label: "Mentors", value: "mentors" },
        { icon: Calendar, label: "Events", value: "events" },
        { icon: PenTool, label: "Blog Authoring", value: "blog" },
        { icon: Activity, label: "Performance", value: "performance" },
        { icon: Settings, label: "Platform Info", value: "platform" },
    ];

    return (
        <div className="flex min-h-screen bg-[#FDFCFB] pt-20">
            {/* Left Sidebar */}
            <aside className="w-80 bg-[#023047] flex flex-col p-8 fixed left-0 top-20 bottom-0 z-20 text-white">
                <div className="flex items-center gap-3 mb-12">
                    <div className="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-white font-bold border border-white/20">A</div>
                    <span className="text-xl font-black tracking-tight">Admin Console</span>
                </div>

                <div className="mb-12">
                    <div className="relative inline-block mb-4">
                        <div className="w-20 h-20 rounded-full border-2 border-[#219EBC] p-1">
                            <img src={session.user?.image || "/avatars/admin.png"} alt="Admin" className="w-full h-full rounded-full object-cover" />
                        </div>
                        <div className="absolute -bottom-1 -right-1 w-6 h-6 bg-[#219EBC] rounded-full flex items-center justify-center shadow-md">
                            <ShieldCheck className="w-3 h-3 text-white" />
                        </div>
                    </div>
                    <h2 className="text-xl font-black mb-1">{session.user?.name}</h2>
                    <p className="text-white/50 text-sm font-medium">{session.user?.email}</p>
                </div>

                <nav className="flex-1 space-y-2">
                    {navItems.map((item) => (
                        <button
                            key={item.label}
                            onClick={() => setActiveTab(item.value)}
                            className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold ${activeTab === item.value
                                ? "bg-white/10 text-[#219EBC]"
                                : "text-white/50 hover:bg-white/5 hover:text-white"
                                }`}
                        >
                            <item.icon className="w-5 h-5" />
                            {item.label}
                        </button>
                    ))}
                </nav>

                <div className="mt-auto">
                    <div className="bg-white/5 p-6 rounded-3xl border border-white/10">
                        <p className="text-xs font-bold text-white/40 uppercase tracking-widest mb-3">System Healthy</p>
                        <div className="flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
                            <span className="text-sm font-bold">Latency: 24ms</span>
                        </div>
                    </div>
                </div>
            </aside>

            {/* Main Content */}
            <main className="flex-1 ml-80 p-12">
                <header className="flex items-center justify-between mb-12">
                    <div>
                        <h1 className="text-3xl font-black text-[#023047] mb-2">Command Center</h1>
                        <p className="text-gray-400 font-medium tracking-tight">Managing the Velonx Ecosystem</p>
                    </div>
                    <div className="flex items-center gap-4">
                        <Button onClick={() => router.push("/")} className="h-14 px-8 bg-white border border-gray-100 text-[#023047] font-black rounded-2xl shadow-sm hover:bg-gray-50 flex items-center gap-2">
                            View Site <Eye className="w-5 h-5" />
                        </Button>
                    </div>
                </header>

                <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
                    <div className="flex justify-between items-center mb-8">
                        <TabsList className="bg-white p-1 rounded-2xl border border-gray-100 shadow-sm">
                            <TabsTrigger value="management" className="px-8 py-3 rounded-xl data-[state=active]:bg-[#023047] data-[state=active]:text-white font-black text-sm">Review Center</TabsTrigger>
                            <TabsTrigger value="blog" className="px-8 py-3 rounded-xl data-[state=active]:bg-[#023047] data-[state=active]:text-white font-black text-sm">Post Blog</TabsTrigger>
                            <TabsTrigger value="career" className="px-8 py-3 rounded-xl data-[state=active]:bg-[#023047] data-[state=active]:text-white font-black text-sm">Career</TabsTrigger>
                            <TabsTrigger value="resources" className="px-8 py-3 rounded-xl data-[state=active]:bg-[#023047] data-[state=active]:text-white font-black text-sm">Resources</TabsTrigger>
                        </TabsList>
                    </div>

                    <TabsContent value="management" className="space-y-12">
                        {/* User Management */}
                        <UserManagement 
                            userRequests={userRequests || []} 
                            onRefetch={refetchRequests}
                        />



                        {/* Project Submissions */}
                        <ProjectSubmissions />
                    </TabsContent>

                    <TabsContent value="mentors" className="space-y-12">
                        <MentorApplications
                            applications={mentorApplications}
                            loading={loadingApplications}
                            onApprove={handleApproveMentorApplication}
                            onReject={handleRejectMentorApplication}
                        />
                    </TabsContent>

                    <TabsContent value="events" className="space-y-12">
                        <Card className="bg-white border-0 shadow-2xl shadow-black/[0.03] rounded-[48px] overflow-hidden">
                            <CardHeader className="p-12 border-b border-gray-50">
                                <h3 className="text-3xl font-black text-[#023047] mb-2">Events Management</h3>
                                <p className="text-gray-400">Event management features coming soon</p>
                            </CardHeader>
                            <CardContent className="p-12">
                                <div className="text-center py-20">
                                    <Calendar className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                    <p className="text-gray-400 text-lg font-bold">Events Management Coming Soon</p>
                                    <p className="text-gray-400 text-sm mt-2">Create and manage events here</p>
                                </div>
                            </CardContent>
                        </Card>
                    </TabsContent>

                    <TabsContent value="blog">
                        <BlogManagement />
                    </TabsContent>

                    <TabsContent value="career">
                        <CareerManagement />
                    </TabsContent>

                    <TabsContent value="resources">
                        <ResourceManagement />
                    </TabsContent>

                    <TabsContent value="performance">
                        <PerformanceMetrics />
                    </TabsContent>

                    <TabsContent value="platform">
                        <Card className="bg-white border-0 shadow-2xl shadow-black/[0.03] rounded-[48px] overflow-hidden">
                            <CardHeader className="p-12 border-b border-gray-50">
                                <h3 className="text-3xl font-black text-[#023047] mb-2">Platform Information</h3>
                                <p className="text-gray-400">System status and configuration</p>
                            </CardHeader>
                            <CardContent className="p-12">
                                <div className="space-y-6">
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="bg-gray-50 p-6 rounded-2xl">
                                            <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Total Users</p>
                                            <p className="text-3xl font-black text-[#023047]">{platformStats?.totalUsers ?? 0}</p>
                                        </div>
                                        <div className="bg-gray-50 p-6 rounded-2xl">
                                            <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Total Events</p>
                                            <p className="text-3xl font-black text-[#023047]">{platformStats?.totalEvents ?? 0}</p>
                                        </div>
                                        <div className="bg-gray-50 p-6 rounded-2xl">
                                            <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Total Projects</p>
                                            <p className="text-3xl font-black text-[#023047]">{platformStats?.totalProjects ?? 0}</p>
                                        </div>
                                        <div className="bg-gray-50 p-6 rounded-2xl">
                                            <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Total Mentors</p>
                                            <p className="text-3xl font-black text-[#023047]">{platformStats?.totalMentors ?? 0}</p>
                                        </div>
                                        <div className="bg-gray-50 p-6 rounded-2xl">
                                            <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Pending Requests</p>
                                            <p className="text-3xl font-black text-[#023047]">{platformStats?.pendingRequests ?? 0}</p>
                                        </div>
                                        <div className="bg-gray-50 p-6 rounded-2xl">
                                            <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">System Status</p>
                                            <div className="flex items-center gap-2 mt-2">
                                                <div className="w-3 h-3 rounded-full bg-green-500 animate-pulse" />
                                                <span className="text-lg font-bold text-green-600">Healthy</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    </TabsContent>
                </Tabs>
            </main>
        </div>
    );
}
