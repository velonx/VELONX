// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
  
  // Connection pool configuration
  // These settings help manage connections efficiently and prevent exhaustion
  relationMode = "prisma"
}

// User Role Enum
enum UserRole {
  STUDENT
  ADMIN
}

// Notification Type Enum
enum NotificationType {
  INFO
  SUCCESS
  AWARD
  EVENT
  WARNING
}

// Gamification Enums
enum BadgeCategory {
  PROJECT       // Project-related achievements
  EVENT         // Event participation
  MENTOR        // Mentorship milestones
  COMMUNITY     // Community contributions
  STREAK        // Login/activity streaks
  MILESTONE     // General milestones
  SPECIAL       // Limited time/special events
}

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum AchievementType {
  FIRST_PROJECT
  FIRST_EVENT
  FIRST_MENTOR_SESSION
  PROJECT_COMPLETION
  EVENT_STREAK
  COLLABORATION
  REFERRAL
  CUSTOM
}

enum XPSource {
  PROJECT_SUBMISSION
  EVENT_ATTENDANCE
  MENTOR_SESSION
  COMMUNITY_CONTRIBUTION
  STREAK_BONUS
  REFERRAL
  BADGE_UNLOCK
  DAILY_LOGIN
  CHALLENGE_COMPLETION
  MANUAL
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

// User Model
model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // For credential-based auth
  role          UserRole  @default(STUDENT)
  bio           String?
  xp            Int       @default(0)
  level         Int       @default(1)
  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  lastLoginDate DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Email notification preferences
  emailNotifications    Boolean   @default(true)
  eventReminders        Boolean   @default(true)
  mentorNotifications   Boolean   @default(true)
  projectNotifications  Boolean   @default(true)
  weeklyDigest          Boolean   @default(true)
  unsubscribeToken      String?
  
  // Gamification fields
  xpMultiplier      Float     @default(1.0)
  referralCode      String?
  referredBy        String?   @db.ObjectId
  referralCount     Int       @default(0)
  lastStreakUpdate  DateTime?
  
  // Relations
  accounts         Account[]
  sessions         Session[]
  eventsCreated    Event[]   @relation("EventCreator")
  eventsAttending  EventAttendee[]
  projectsOwned    Project[] @relation("ProjectOwner")
  projectMembers   ProjectMember[]
  blogPosts        BlogPost[]
  meetingsCreated  Meeting[] @relation("MeetingCreator")
  meetingAttendees MeetingAttendee[]
  userRequests     UserRequest[]
  mentorSessions   MentorSession[] @relation("StudentSessions")
  mentorReviews    MentorReview[]  @relation("StudentReviews")
  notifications    Notification[]
  resourceVisits   ResourceVisit[]
  
  // Gamification relations
  badges           UserBadge[]
  achievements     Achievement[]
  xpTransactions   XPTransaction[]
  
  @@map("users")
}

// NextAuth Models
model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Gamification Models
model Badge {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  name        String        @unique
  description String
  imageUrl    String
  category    BadgeCategory
  xpReward    Int
  rarity      BadgeRarity   @default(COMMON)
  criteria    String        // JSON string describing unlock criteria
  createdAt   DateTime      @default(now())
  
  userBadges  UserBadge[]
  
  @@map("badges")
}

model UserBadge {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  badgeId    String   @db.ObjectId
  earnedAt   DateTime @default(now())
  progress   Int      @default(0) // For progressive badges
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge      Badge    @relation(fields: [badgeId], references: [id])
  
  @@unique([userId, badgeId])
  @@map("user_badges")
}

model Achievement {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  userId      String          @db.ObjectId
  type        AchievementType
  title       String
  description String
  xpEarned    Int
  timestamp   DateTime        @default(now())
  metadata    String?         // JSON for additional data
  
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("achievements")
}

model XPTransaction {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  amount      Int       // Can be positive or negative
  multiplier  Float     @default(1.0)
  reason      String
  source      XPSource
  metadata    String?   // JSON for additional context
  timestamp   DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("xp_transactions")
}

model LeaderboardSnapshot {
  id        String            @id @default(auto()) @map("_id") @db.ObjectId
  period    LeaderboardPeriod
  startDate DateTime
  endDate   DateTime
  data      String            // JSON array of user rankings
  createdAt DateTime          @default(now())
  
  @@unique([period, startDate])
  @@map("leaderboard_snapshots")
}


// Event Enums
enum EventType {
  HACKATHON
  WORKSHOP
  WEBINAR
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum AttendeeStatus {
  REGISTERED
  ATTENDED
  CANCELLED
}

// Event Model
model Event {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  type        EventType
  date        DateTime
  endDate     DateTime?
  location    String?
  meetingLink String?
  imageUrl    String?
  maxSeats    Int
  status      EventStatus @default(UPCOMING)
  creatorId   String      @db.ObjectId
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  creator     User            @relation("EventCreator", fields: [creatorId], references: [id])
  attendees   EventAttendee[]
  
  @@map("events")
}

// Event Attendee Junction Model
model EventAttendee {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  eventId   String         @db.ObjectId
  userId    String         @db.ObjectId
  status    AttendeeStatus @default(REGISTERED)
  createdAt DateTime       @default(now())
  
  event Event @relation(fields: [eventId], references: [id])
  user  User  @relation(fields: [userId], references: [id])
  
  @@unique([eventId, userId])
  @@map("event_attendees")
}

// Project Enums
enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

enum ProjectCategory {
  WEB_DEV
  MOBILE
  AI_ML
  DATA_SCIENCE
  DEVOPS
  DESIGN
  OTHER
}

enum ProjectDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// Project Model
model Project {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  techStack   String[]
  status      ProjectStatus     @default(PLANNING)
  category    ProjectCategory   @default(OTHER)
  difficulty  ProjectDifficulty @default(BEGINNER)
  imageUrl    String?
  githubUrl   String?
  liveUrl     String?
  outcomes    String?
  ownerId     String            @db.ObjectId
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  // Relations
  owner   User            @relation("ProjectOwner", fields: [ownerId], references: [id])
  members ProjectMember[]
  
  @@map("projects")
}

// Project Member Junction Model
model ProjectMember {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId String   @db.ObjectId
  userId    String   @db.ObjectId
  role      String?
  joinedAt  DateTime @default(now())
  
  project Project @relation(fields: [projectId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  
  @@unique([projectId, userId])
  @@map("project_members")
}

// Mentor Model
model Mentor {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  email         String          @unique
  expertise     String[]
  company       String
  bio           String
  imageUrl      String?
  rating        Float           @default(0)
  totalSessions Int             @default(0)
  available     Boolean         @default(true)
  linkedinUrl   String?
  hourlyRate    Float?          // Optional pricing
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  sessions      MentorSession[]
  reviews       MentorReview[]
  
  @@map("mentors")
}

// Mentor Session Enums
enum SessionStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Mentor Session Model
model MentorSession {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  mentorId    String        @db.ObjectId
  studentId   String        @db.ObjectId
  title       String
  description String?
  date        DateTime
  duration    Int           // in minutes
  meetingLink String?
  status      SessionStatus @default(PENDING)
  notes       String?       // Session notes
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relations
  mentor  Mentor        @relation(fields: [mentorId], references: [id])
  student User          @relation("StudentSessions", fields: [studentId], references: [id])
  review  MentorReview?
  
  @@map("mentor_sessions")
}

// Mentor Review Model
model MentorReview {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionId String   @unique @db.ObjectId
  mentorId  String   @db.ObjectId
  studentId String   @db.ObjectId
  rating    Int      // 1-5 stars
  comment   String?
  createdAt DateTime @default(now())
  
  // Relations
  session MentorSession @relation(fields: [sessionId], references: [id])
  mentor  Mentor        @relation(fields: [mentorId], references: [id])
  student User          @relation("StudentReviews", fields: [studentId], references: [id])
  
  @@map("mentor_reviews")
}

// Resource Enums
enum ResourceCategory {
  PROGRAMMING
  DESIGN
  BUSINESS
  DATA_SCIENCE
  DEVOPS
  MOBILE
  WEB
  OTHER
}

enum ResourceType {
  ARTICLE
  VIDEO
  COURSE
  BOOK
  TOOL
  DOCUMENTATION
}

// Resource Model
model Resource {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  category    ResourceCategory
  type        ResourceType
  url         String
  imageUrl    String?
  accessCount Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Relations
  visits      ResourceVisit[]
  
  @@map("resources")
}

// ResourceVisit Model - Tracks user visits to resources for XP awards
model ResourceVisit {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  resourceId String   @db.ObjectId
  visitedAt  DateTime @default(now())
  xpAwarded  Boolean  @default(false)
  
  // Relations
  user     User     @relation(fields: [userId], references: [id])
  resource Resource @relation(fields: [resourceId], references: [id])
  
  @@unique([userId, resourceId])
  @@index([userId])
  @@index([resourceId])
  @@map("resource_visits")
}

// BlogPost Enums
enum PostStatus {
  DRAFT
  PUBLISHED
}

// BlogPost Model
model BlogPost {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  content     String
  excerpt     String?
  imageUrl    String?
  tags        String[]
  status      PostStatus @default(DRAFT)
  authorId    String     @db.ObjectId
  publishedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // Relations
  author User @relation(fields: [authorId], references: [id])
  
  @@map("blog_posts")
}

// Meeting Enums
enum MeetingAttendeeStatus {
  INVITED
  ACCEPTED
  DECLINED
  ATTENDED
}

// Meeting Model
model Meeting {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  date        DateTime
  duration    Int               // in minutes
  platform    String
  meetingLink String?
  creatorId   String            @db.ObjectId
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  // Relations
  creator   User              @relation("MeetingCreator", fields: [creatorId], references: [id])
  attendees MeetingAttendee[]
  
  @@map("meetings")
}

// Meeting Attendee Junction Model
model MeetingAttendee {
  id        String                @id @default(auto()) @map("_id") @db.ObjectId
  meetingId String                @db.ObjectId
  userId    String                @db.ObjectId
  status    MeetingAttendeeStatus @default(INVITED)
  createdAt DateTime              @default(now())
  
  meeting Meeting @relation(fields: [meetingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  
  @@unique([meetingId, userId])
  @@map("meeting_attendees")
}

// UserRequest Enums
enum RequestType {
  ACCOUNT_APPROVAL
  PROJECT_SUBMISSION
  MENTOR_APPLICATION
  PROJECT_JOIN
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// UserRequest Model
model UserRequest {
  id         String        @id @default(auto()) @map("_id") @db.ObjectId
  userId     String        @db.ObjectId
  type       RequestType
  status     RequestStatus @default(PENDING)
  reason     String?
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id])
  
  @@map("user_requests")
}

// Notification Model
model Notification {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  userId      String           @db.ObjectId
  title       String
  description String
  type        NotificationType @default(INFO)
  read        Boolean          @default(false)
  actionUrl   String?          // Optional URL for clickable notifications
  metadata    Json?            // Optional additional data
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([userId, read])
  @@map("notifications")
}

// Mock Interview Enums
enum InterviewType {
  TECHNICAL_FRONTEND
  TECHNICAL_BACKEND
  DSA
  SYSTEM_DESIGN
  BEHAVIORAL
}

enum ExperienceLevel {
  INTERN
  JUNIOR
  SENIOR
}

enum MockInterviewStatus {
  PENDING
  APPROVED
  REJECTED
  SCHEDULED
  COMPLETED
}

// Mock Interview Application Model
model MockInterview {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  userId          String              @db.ObjectId
  email           String
  preferredDate   DateTime
  preferredTime   String
  interviewType   InterviewType
  experienceLevel ExperienceLevel
  status          MockInterviewStatus @default(PENDING)
  scheduledDate   DateTime?
  meetingLink     String?
  feedback        String?
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@map("mock_interviews")
}

// Opportunity Type Enum
enum OpportunityType {
  INTERNSHIP
  JOB
}

enum OpportunityStatus {
  ACTIVE
  CLOSED
  DRAFT
}

// Opportunity Model (for both Internships and Jobs)
model Opportunity {
  id           String            @id @default(auto()) @map("_id") @db.ObjectId
  type         OpportunityType
  title        String
  company      String
  description  String
  requirements String[]
  location     String
  salary       String?
  duration     String?           // For internships
  applyUrl     String
  imageUrl     String?
  status       OpportunityStatus @default(ACTIVE)
  postedBy     String            // Admin ID
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  @@map("opportunities")
}

// Audit Log Model for security event tracking
model AuditLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  timestamp DateTime @default(now())
  userId    String?  @db.ObjectId
  action    String   // e.g., "LOGIN", "LOGOUT", "CREATE_PROJECT", "DELETE_USER"
  resource  String   // e.g., "USER", "PROJECT", "BLOG_POST"
  ipAddress String
  userAgent String
  result    String   // "success" or "failure"
  metadata  Json?    // Additional context data
  
  @@index([userId, timestamp])
  @@index([action, timestamp])
  @@index([timestamp])
  @@index([result, timestamp])
  @@map("audit_logs")
}
